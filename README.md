# Project Setup Guide

## Apeworx setup

This guide provides step-by-step instructions to:

1. Fork the Ethereum Sepolia testnet using Anvil.
2. Set up accounts for use with ApeWorx.

### Prerequisites

- Install [ApeWorx](https://docs.apeworx.io/ape/stable/) CLI.
- Obtain an API key from [Alchemy](https://www.alchemy.com/).

---
Run: `git clone https://github.com/moses966/prediction-market-quickstart.git`

And then inside the `prediction-market-quickstart` folder, run `poetry install` and then `poetry shell`

Finally, run the following commands to compile the necessary contracts:

```bash
ape compile contracts/src
```

```bash
ape compile contracts/dependencies/sandbox
```

## Step 1: Fork the Sepolia Testnet with Anvil

Anvil is a powerful tool for local blockchain testing. We will fork the Ethereum Sepolia testnet using Alchemy as the provider.

### Command to Fork

Run the following command in your terminal:

```bash
anvil --fork-url https://eth-sepolia.g.alchemy.com/v2/<api-key>
```

### Replace `<api-key>`

- Substitute `<api-key>` with your actual Alchemy API key.
- This forks the Sepolia network and connects your local Anvil instance to the Sepolia testnet.

Anvil will display output containing local accounts, their private keys, and the local RPC URL (default: `http://127.0.0.1:8545`). Note these details for the next step.

For tests, run the following command:

```bash
ape test -s tests/test_market.py -l --network ethereum:local:foundry
```

---

## Step 2: Set Up Accounts for Use in ApeWorx

ApeWorx simplifies smart contract development, testing, and deployment. We will set up three accounts using the private keys generated by Anvil.

### Command to Import Accounts

Run the following commands to import the accounts into ApeWorx:

#### Account 1

```bash
ape accounts import account1
```

Follow the prompts and provide the private key for the first account displayed by Anvil.

#### Account 2

```bash
ape accounts import account2
```

Follow the prompts and provide the private key for the second account displayed by Anvil.

#### Account 3

```bash
ape accounts import account3
```

Follow the prompts and provide the private key for the third account displayed by Anvil.

### Verify Imported Accounts

To ensure the accounts were imported successfully, run:

```bash
ape accounts list
```

You should see `account1`, `account2`, and `account3` listed as available accounts.

---

## Deploying and Interacting with deployed contracts

- With the Sepolia fork running on Anvil and accounts set up, you're ready to deploy and interact with smart contracts locally while leveraging the Sepolia state.

### deploy UMA Oracle SandBox

First, we are going to deploy the UMA Oracle SandBox by running:

```bash
ape run oracle_sand_box deploy --network ethereum:local:foundry
```

At the end of this run, all the relevant addresses shall be saved in the `deployments.json` file.
We are now ready to deploy the prediction market and interact with it.

To deploy the prediction market, run the command:

```bash
APE_METHOD=deploy_market ape run market --network ethereum:local:foundry
```

### Initialize market

It's now time to initialize the market. Run:

```bash
APE_METHOD=init ape run market --network ethereum:local:foundry
```

Here the description shows that it's a market based on whether Manchester United won the 2025 Champions League Title or not. The two possible outcomes are `YES` or `NO`. We offer `100` units of `currency` to the asserter of the claim and require a bond of `5,000` units of `currecny` to assert or dispute the assertion. Therefore, we mint the amount of asserter rewards and approve them before creating the market.
Please take note of the `deployer's` currency balance before and after market initialization.

### create outcome tokens

We can now create Outcome tokens by running the following command:

```bash
APE_METHOD=create ape run market --network ethereum:local:foundry
```

Here, we again mint the necessary tokens(`10,000 units`) to then create the outcome tokens.
With an amount `10,000 units` of `currency` we get `10,000 outcome_token_one` and `10,000 outcome_token_two` tokens.
It's very important to take note of the printed balances before and after token creation.

### redeem outcome tokens

At any point before the market is settled we can redeem outcome tokens. By redeeming an amount we are burning the same amount of outcome_token_one and outcome_token_two to receive that amount of currency.
To do this, run:

```bash
APE_METHOD=redeem ape run market --network ethereum:local:foundry
```

Please take note of the printed balances.

### simulate trade

Now, let's simulate how the `deployer` would trade one position of the market by transferring the remaining `5,000` outcome_token_one to another `user`. By doing this, `deployer` is now only exposed to the outcome two ("NO") because he only holds outcome_token_two. On the other side, `user` is exposed to the outcome one ("YES") as he has traded some other currency against outcome_token_one. This trade is out of the scope of this example, thats why we simulate it by running the following transfer:

```bash
APE_METHOD=trade ape run market --network ethereum:local:foundry
```

Please note the printed balances.

### assert prediction

At this point, let's imagine that Manchester United won the 2025 Champions League title. Then anyone can now assert that this occurred by calling `assert_market` with outcome "YES" as the claim defined in `description` is true. We can do it, from the `asserter_wallet`, by running the following command:

```bash
APE_METHOD=assert ape run market --network ethereum:local:foundry
```

### settle assertion

To archive this, we need to move forward `2 hours` to go pass the `challenge window` of the assertion:

```bash
APE_METHOD=settle_assertion ape run market --network ethereum:local:foundry
```

The printed `asserter's` balance cleary shows that the `asserter_wallet` received back the `assertion bond` plus their `reward`.

### settle outcome tokens

Now, both the `deployer` and `user` can settle their outcome tokens:

```bash
APE_METHOD=settle_tokens ape run market --network ethereum:local:foundry
```

### final balances

Finally we can see how the `user` won the bet, as he got `outcome_token_one` so he now has `5,000` `currency` and the deployer wallet only has `5,000` `currency` from his initial `10,000`:

```bash
APE_METHOD=balances ape run market --network ethereum:local:foundry
```
